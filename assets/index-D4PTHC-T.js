import"https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js";import"https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();const G=document.getElementById("cam"),f=document.getElementById("drawCanvas"),O=document.getElementById("overlay"),o=f.getContext("2d",{alpha:!1,desynchronized:!0}),c=O.getContext("2d",{alpha:!0,desynchronized:!0}),R=document.getElementById("mode"),at=document.getElementById("color"),D=document.getElementById("size"),W=document.getElementById("smooth"),X=document.getElementById("opacity"),rt=document.getElementById("eraserToggle"),st=document.getElementById("clear"),ct=document.getElementById("save"),lt=document.getElementById("status"),dt=document.getElementById("sizeOutput"),ut=document.getElementById("smoothOutput"),ht=document.getElementById("opacityOutput");o.imageSmoothingEnabled=!0;o.imageSmoothingQuality="high";function M(t){const e=parseFloat(t.min)||0,i=parseFloat(t.max)||100,n=((parseFloat(t.value)||0)-e)/(i-e)*100;if(n===0)t.style.background="transparent";else if(n===100)t.style.background="var(--fg)";else{const r=t.offsetWidth,d=r-48,x=(48/2+n/100*d)/r*100;t.style.background=`linear-gradient(to right, var(--fg) 0%, var(--fg) ${x}%, transparent ${x}%, transparent 100%)`}}const H=.75;let u=null,g=null,F=null,p=null,C={x:0,y:0},l=!1,v=0;const z=6;let h=null;const U=.3,V=.16+(1-H)*.2,mt=V+.08;let P=0,T=0;const ft=4,gt=2;let w=!1;const pt=80;let m=null;const J=.25;let yt=.9,xt=.75,B=0,A=0;const Et=3,vt=2;let I=!1;function K(t){o.save(),S()?(o.globalCompositeOperation="destination-out",o.globalAlpha=1):(o.globalCompositeOperation="source-over",o.globalAlpha=tt()),o.beginPath(),o.fillStyle=S()?"rgba(0,0,0,1)":Y(),o.arc(t.x,t.y,Math.max(1,$()/2),0,Math.PI*2),o.fill(),o.restore()}function wt(t){const e=et(t),i=t[0];function a(j){return Math.hypot(j.x-i.x,j.y-i.y)}const n=a(t[8]),s=a(t[6]),r=a(t[12]),d=a(t[10]),b=a(t[16]),x=a(t[14]),N=a(t[20]),q=a(t[18]),E=Math.hypot(t[4].x-t[5].x,t[4].y-t[5].y)/e,L=(n-s)/e,nt=(r-d)/e,ot=(b-x)/e,it=(N-q)/e;return{hsize:e,idxMetric:L,midMetric:nt,ringMetric:ot,pinkMetric:it,thumbNearIdxMcp:E}}function It(){return .85-parseFloat(W.value)/.95*.6}function Q(t,e=!1){c.save(),c.beginPath(),S()&&!e?(c.fillStyle="rgba(255,255,255,0.9)",c.strokeStyle="rgba(0,0,0,0.4)",c.lineWidth=2):e?(c.fillStyle="rgba(0,0,0,0.12)",c.strokeStyle="rgba(0,0,0,0.15)",c.lineWidth=1):(c.fillStyle="rgba(0,0,0,0.95)",c.strokeStyle="rgba(0,0,0,0.15)",c.lineWidth=1);const i=Math.max(4,$()/2);c.arc(t.x,t.y,i,0,Math.PI*2),c.fill(),c.stroke(),c.closePath(),c.restore()}function k(){[f,O].forEach(t=>{const e=t.getBoundingClientRect(),i=window.devicePixelRatio||1,a=Math.round(e.width*i),n=Math.round(e.height*i);(t.width!==a||t.height!==n)&&(t.width=a,t.height=n)})}function Y(){return at.value}function tt(){return parseFloat(X.value)}function $(){return parseFloat(D.value)*(window.devicePixelRatio||1)}function et(t){const e=t[0],i=t[9];return Math.hypot(e.x-i.x,e.y-i.y)||1e-4}function S(){return rt.checked}function Mt(t,e){const i=(1-t.x)*e.width,a=t.y*e.height;return{x:i,y:a}}function bt(){return{maxNumHands:1,modelComplexity:1,minDetectionConfidence:H,minTrackingConfidence:Math.max(.5,H-.2)}}function Ct(t,e,i){const a=Math.max(0,1-i/(z+1));return{x:t.x+e.x*i*a,y:t.y+e.y*i*a}}function y(t){lt.textContent=t}function _(t,e){if(!t){o.beginPath(),o.moveTo(e.x,e.y),o.stroke();return}o.save(),S()?(o.globalCompositeOperation="destination-out",o.globalAlpha=1):(o.globalCompositeOperation="source-over",o.globalAlpha=tt()),o.lineWidth=$(),o.lineCap="round",o.lineJoin="round",o.strokeStyle=S()?"rgba(0,0,0,1)":Y(),o.beginPath(),o.moveTo(t.x,t.y),o.lineTo(e.x,e.y),o.stroke(),o.restore()}await new Promise(t=>requestAnimationFrame(t));k();const Z=new Hands({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${t}`});Z.setOptions(bt());Z.onResults(t=>{if(k(),c.clearRect(0,0,O.width,O.height),!t.multiHandLandmarks||t.multiHandLandmarks.length===0){if(v++,y(v<=z?`Hand briefly lost — predicting (${v})`:"No hand detected"),h!==null&&(h*=.98),m!==null&&(m*=.98),v<=z&&p){const r=Ct(p,C,v);l&&_(p,r),p=r,Q(r,!0)}else l&&(l=!1);return}v=0;const e=t.multiHandLandmarks[0],i=Mt(e[8],f);F&&(C.x=i.x-F.x,C.y=i.y-F.y),F=i;const a=It();u?(u.x=a*i.x+(1-a)*u.x,u.y=a*i.y+(1-a)*u.y):u={x:i.x,y:i.y};const n={x:u.x,y:u.y};if(R.value==="pinch"){const r=Math.hypot(e[8].x-e[4].x,e[8].y-e[4].y),d=Math.abs(e[8].z-e[4].z),b=et(e),x=r/b,N=d/b;let E=x-.2*N;E=Math.max(0,Math.min(2,E)),h===null?h=E:h=U*E+(1-U)*h,h<=V?(P++,T=0):h>=mt?(T++,P=0):(P=Math.max(0,P-1),T=Math.max(0,T-1));const L=Math.hypot(C.x||0,C.y||0);!w&&P>=ft&&L<pt&&(w=!0,K(n),l=!0),w&&T>=gt&&(w=!1,l=!1),w?(y("Pinched — drawing"),_(p,n),l=!0):(l&&(l=!1),y("Hand detected — pinch to draw (or switch to Index mode)"))}else{const r=wt(e);let d=r.idxMetric*1.25-r.midMetric*.8-r.ringMetric*.7-r.pinkMetric*.6+r.thumbNearIdxMcp*.1;d=Math.max(-2,Math.min(2,d)),m===null?m=d:m=J*d+(1-J)*m,m>=yt?(B++,A=0):m<=xt?(A++,B=0):(B=Math.max(0,B-1),A=Math.max(0,A-1)),!I&&B>=Et&&(I=!0,K(n),l=!0),I&&A>=vt&&(I=!1,l=!1),I?(y("Index extended — drawing"),_(p,n),l=!0):(l&&(l=!1),y("Hand detected — extend index to draw (or switch to Pinch)"))}const s=.5;g?(g.x=s*n.x+(1-s)*g.x,g.y=s*n.y+(1-s)*g.y):g={x:n.x,y:n.y},Q(g,!(R.value==="pinch"&&w||R.value==="index"&&I)),p=n});try{await new Camera(G,{onFrame:async()=>{await Z.send({image:G})},width:1280,height:720}).start(),y("Camera started — allow camera and try Pinch or Index modes"),o.fillStyle="#ffffff",o.fillRect(0,0,f.width,f.height)}catch(t){console.error(t),alert("Camera start failed: "+(t.message||t)),y("Camera error")}window.addEventListener("resize",k);st.addEventListener("click",()=>o.clearRect(0,0,f.width,f.height));ct.addEventListener("click",()=>{const t=document.createElement("a");t.download=`air-draw-${Date.now()}.png`,t.href=f.toDataURL("image/png"),t.click()});D.addEventListener("input",t=>{dt.textContent=Math.round(t.target.value),M(t.target)});W.addEventListener("input",t=>{ut.textContent=parseFloat(t.target.value).toFixed(2),M(t.target)});X.addEventListener("input",t=>{ht.textContent=parseFloat(t.target.value).toFixed(2),M(t.target)});requestAnimationFrame(()=>{M(D),M(W),M(X)});
